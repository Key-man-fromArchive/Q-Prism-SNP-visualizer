<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASG-PCR SNP Discrimination Analyzer</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/dark-theme.css">
    <link rel="stylesheet" href="/css/print.css">
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
    <header>
        <h1>ASG-PCR SNP Discrimination Analyzer</h1>
        <a href="https://www.invirustech.com" target="_blank" rel="noopener" class="powered-by">Powered by Invirustech</a>
        <div id="session-info" class="hidden">
            <span id="instrument-badge" class="badge"></span>
            <span id="wells-badge" class="badge"></span>
            <span id="cycles-badge" class="badge"></span>
            <div id="qc-badges" style="display:flex;gap:8px;"></div>
        </div>
        <div class="export-buttons hidden" id="export-buttons">
            <button id="export-csv-btn" class="badge" title="Export CSV (Ctrl+E)">CSV</button>
            <button id="export-png-btn" class="badge" title="Export scatter PNG">PNG</button>
            <button id="export-print-btn" class="badge" title="Print report">Print</button>
            <button id="export-pdf-btn" class="badge" title="Export PDF report">PDF</button>
            <button id="new-upload-btn" class="badge" title="Upload another file">+ New</button>
        </div>
        <div class="undo-redo-buttons hidden" id="undo-redo-buttons">
            <button id="undo-btn" class="badge" title="Undo (Ctrl+Z)" disabled>Undo</button>
            <button id="redo-btn" class="badge" title="Redo (Ctrl+Y)" disabled>Redo</button>
        </div>
        <button id="dark-mode-toggle" title="Toggle dark mode"></button>
    </header>

    <main>
        <!-- Upload Zone -->
        <div id="upload-zone">
            <div id="drop-area">
                <div class="upload-icon">&#128196;</div>
                <p>Drag & drop your raw fluorescence file here</p>
                <p class="sub">QuantStudio (.eds, .xls) | CFX Opus (.xlsx, .zip, or drag XML files/folder)</p>
                <div class="browse-buttons">
                    <button id="browse-btn">Browse Files</button>
                    <button id="browse-folder-btn">Browse Folder</button>
                </div>
                <input type="file" id="file-input" accept=".eds,.xls,.xlsx,.pcrd,.zip,.xml" multiple hidden>
                <input type="file" id="folder-input" webkitdirectory hidden>
            </div>
            <div id="upload-progress" class="hidden">
                <div class="progress-bar"><div class="progress-fill"></div></div>
                <p id="upload-status">Uploading...</p>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div id="analysis-panel" class="hidden">
            <nav class="tabs">
                <button class="tab active" data-tab="analysis">Analysis</button>
                <button class="tab" data-tab="protocol">Protocol</button>
                <button class="tab" data-tab="settings">Settings</button>
                <button class="tab" data-tab="quality">Quality</button>
                <button class="tab" data-tab="statistics">Statistics</button>
                <button class="tab" data-tab="compare">Compare Runs</button>
                <button class="tab" data-tab="batch">Batch</button>
            </nav>

            <!-- Analysis Tab -->
            <div id="tab-analysis" class="tab-content active">
                <!-- Cycle Slider -->
                <div id="cycle-control">
                    <div id="window-selector" class="hidden"></div>
                    <label id="cycle-label">Cycle: <span id="cycle-value">1</span> / <span id="cycle-max">1</span></label>
                    <div class="slider-row">
                        <button id="play-btn" title="Play/Pause">&#9654;</button>
                        <input type="range" id="cycle-slider" min="1" max="1" value="1">
                    </div>
                </div>

                <div class="analysis-grid">
                    <!-- Scatter Plot -->
                    <div class="panel scatter-panel">
                        <h3>Allele Discrimination</h3>
                        <div id="scatter-plot"></div>
                    </div>

                    <!-- Plate View -->
                    <div class="panel plate-panel">
                        <h3>Plate View (96-well)</h3>
                        <div id="plate-grid"></div>
                    </div>

                    <!-- Detail Panel -->
                    <div class="panel detail-panel">
                        <h3>Well Details</h3>
                        <div id="detail-content">
                            <p class="placeholder">Click a well to see details</p>
                        </div>
                        <div id="amplification-plot" class="hidden"></div>
                        <div id="ct-info" class="hidden">
                            <h4 style="font-size:13px;color:var(--text-muted);margin:12px 0 4px;">Ct/Cq Values</h4>
                            <div id="ct-summary"></div>
                        </div>
                    </div>

                    <!-- Results Table -->
                    <div class="panel results-panel">
                        <h3>Genotype Results</h3>
                        <div id="results-plate"></div>
                    </div>
                </div>

                <!-- Amplification Overlay -->
                <div class="panel" style="margin-top:16px;">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                        <h3 style="margin-bottom:0;">Amplification Overlay</h3>
                        <button id="toggle-overlay-btn" class="badge" style="cursor:pointer;">Show Overlay</button>
                        <select id="overlay-channel-select" style="padding:2px 8px;border:1px solid var(--border);border-radius:4px;font-size:12px;">
                            <option value="fam">FAM</option>
                            <option value="allele2">Allele2</option>
                        </select>
                    </div>
                    <div id="overlay-container" class="hidden">
                        <div id="overlay-plot" style="width:100%;height:400px;"></div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="tab-settings" class="tab-content">
                <div class="settings-grid">
                    <div class="panel">
                        <h3>Assay Presets</h3>
                        <div class="settings-form">
                            <div class="settings-group">
                                <div style="display:flex;gap:8px;align-items:center;">
                                    <select id="preset-select" style="flex:1;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-size:13px;background:var(--surface);color:var(--text);">
                                        <option value="">-- Select Preset --</option>
                                    </select>
                                    <button id="apply-preset-btn" class="settings-action-btn" style="margin-top:0;padding:6px 12px;font-size:13px;">Apply</button>
                                    <button id="delete-preset-btn" class="badge" style="cursor:pointer;color:var(--danger);" title="Delete selected preset">Del</button>
                                </div>
                            </div>
                            <div class="settings-group">
                                <div style="display:flex;gap:8px;align-items:center;">
                                    <input type="text" id="preset-name-input" placeholder="New preset name" style="flex:1;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-size:13px;">
                                    <button id="save-preset-btn" class="settings-action-btn" style="margin-top:0;padding:6px 12px;font-size:13px;background:var(--accent);">Save</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="panel">
                        <h3>Normalization</h3>
                        <div class="settings-form">
                            <div class="settings-group" id="rox-normalize-group">
                                <label>
                                    <input type="checkbox" id="rox-normalize-checkbox">
                                    ROX normalization (FAM/ROX, Allele2/ROX)
                                </label>
                                <p class="settings-hint">Recommended for ABI/QuantStudio. Not recommended for Bio-Rad CFX (ROX crosstalk).</p>
                            </div>
                        </div>
                    </div>

                    <div class="panel">
                        <h3>Scatter Plot Axis</h3>
                        <div class="settings-form">
                            <div class="settings-group">
                                <label>
                                    <input type="checkbox" id="fix-axis-checkbox">
                                    Fix axis range
                                </label>
                                <div class="settings-inputs">
                                    <div class="settings-field">
                                        <span>X axis min</span>
                                        <input type="number" id="x-axis-min" step="0.5" value="0">
                                    </div>
                                    <div class="settings-field">
                                        <span>X axis max</span>
                                        <input type="number" id="x-axis-max" step="0.5" value="12">
                                    </div>
                                    <div class="settings-field">
                                        <span>Y axis min</span>
                                        <input type="number" id="y-axis-min" step="0.5" value="0">
                                    </div>
                                    <div class="settings-field">
                                        <span>Y axis max</span>
                                        <input type="number" id="y-axis-max" step="0.5" value="12">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="panel">
                        <h3>Auto Clustering</h3>
                        <div class="settings-form">
                            <div class="settings-group">
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="cluster-algo" value="threshold" checked>
                                        Threshold
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="cluster-algo" value="kmeans">
                                        K-means
                                    </label>
                                </div>
                            </div>

                            <div id="threshold-config" class="settings-group">
                                <div class="settings-inputs">
                                    <div class="settings-field">
                                        <span>NTC threshold</span>
                                        <input type="number" id="ntc-threshold" min="0" step="0.05" value="0.1">
                                    </div>
                                    <div class="settings-field">
                                        <span>Allele1 ratio max</span>
                                        <input type="number" id="allele1-ratio-max" min="0" max="1" step="0.05" value="0.4">
                                    </div>
                                    <div class="settings-field">
                                        <span>Allele2 ratio min</span>
                                        <input type="number" id="allele2-ratio-min" min="0" max="1" step="0.05" value="0.6">
                                    </div>
                                </div>
                            </div>

                            <div id="kmeans-config" class="settings-group hidden">
                                <div class="settings-inputs">
                                    <div class="settings-field">
                                        <span>Number of clusters</span>
                                        <input type="number" id="n-clusters" min="2" max="6" step="1" value="4">
                                    </div>
                                </div>
                            </div>

                            <button id="run-clustering-btn" class="settings-action-btn">Run Auto Clustering</button>
                            <button id="toggle-threshold-lines-btn" class="settings-action-btn" style="background:var(--surface);color:var(--primary);border:1px solid var(--primary);margin-left:8px;">Show Threshold Lines</button>
                        </div>
                    </div>

                    <div class="panel">
                        <h3>Display Layers</h3>
                        <div class="settings-form">
                            <div class="settings-group">
                                <label>
                                    <input type="checkbox" id="show-auto-cluster" checked>
                                    Show auto-clustering layer
                                </label>
                            </div>
                            <div class="settings-group">
                                <label>
                                    <input type="checkbox" id="show-manual-types" checked>
                                    Show manual well types layer
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quality Tab -->
            <div id="tab-quality" class="tab-content">
                <div class="panel">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                        <h3 style="margin-bottom:0;">Signal Quality Scores</h3>
                        <button id="refresh-quality-btn" class="badge" style="cursor:pointer;">Refresh</button>
                    </div>
                    <div id="quality-content">
                        <p class="placeholder">Upload data to see quality scores.</p>
                    </div>
                </div>
            </div>

            <!-- Statistics Tab -->
            <div id="tab-statistics" class="tab-content">
                <div class="panel">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                        <h3 style="margin-bottom:0;">Population Statistics</h3>
                        <button id="refresh-stats-btn" class="badge" style="cursor:pointer;">Refresh</button>
                    </div>
                    <div id="statistics-content">
                        <p class="placeholder">Upload data and run clustering to see statistics.</p>
                    </div>
                </div>
            </div>

            <!-- Compare Tab -->
            <div id="tab-compare" class="tab-content"></div>

            <!-- Batch Tab -->
            <div id="tab-batch" class="tab-content"></div>

            <!-- Protocol Tab -->
            <div id="tab-protocol" class="tab-content">
                <div class="protocol-grid">
                    <div class="panel">
                        <h3>PCR Protocol Steps</h3>
                        <table id="protocol-table">
                            <thead>
                                <tr>
                                    <th>Step</th>
                                    <th>Label</th>
                                    <th>Temp (&deg;C)</th>
                                    <th>Duration (s)</th>
                                    <th>Cycles</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <div class="protocol-actions">
                            <button id="add-step-btn">+ Add Step</button>
                            <button id="save-protocol-btn">Save</button>
                        </div>
                    </div>
                    <div class="panel">
                        <h3>Temperature Profile</h3>
                        <div id="protocol-plot"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module" src="/js/app.js"></script>
</body>
</html>
